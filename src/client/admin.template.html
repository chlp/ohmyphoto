<!-- GENERATED FILE: edit `src/client/admin.template.html` and run `node scripts/build-assets.mjs` -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin | OhMyPhoto</title>
  <meta name="robots" content="noindex,nofollow" />
  <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; }
    input, textarea, button { font: inherit; }
    .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    .card { border: 1px solid #ddd; border-radius: 8px; padding: 16px; margin: 12px 0; }
    .muted { color: #666; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid #eee; padding: 8px; vertical-align: top; }
    textarea { width: 100%; min-height: 80px; }
    .small { font-size: 12px; }
    .danger { background: #b42318; color: #fff; border: 0; padding: 8px 12px; border-radius: 6px; }
    .primary { background: #175cd3; color: #fff; border: 0; padding: 8px 12px; border-radius: 6px; }
    .ghost { background: #fff; border: 1px solid #ccc; padding: 8px 12px; border-radius: 6px; }
    code { background: #f6f6f6; padding: 2px 4px; border-radius: 4px; }
  </style>
</head>
<body>
  <h1>OhMyPhoto Admin</h1>

  <!-- Turnstile widget container (kept off-screen to avoid layout impact) -->
  <div id="turnstile-widget" style="position:absolute;left:-9999px;top:0;width:1px;height:1px;overflow:hidden;"></div>

  <div class="card">
    <h2>Auth</h2>
    <div class="row">
      <label>Admin token:</label>
      <input id="token" type="password" placeholder="ADMIN_TOKEN" style="min-width:280px" />
      <button class="ghost" id="saveToken">Login</button>
      <button class="ghost" id="logout">Logout</button>
    </div>
    <div class="muted small" id="authInfo"></div>
  </div>

  <div class="card">
    <h2>Create album</h2>
    <div class="row">
      <label>Album ID:</label>
      <input id="newAlbumId" placeholder="abc" />
      <label>Title:</label>
      <input id="newTitle" placeholder="OhMyPhoto" style="min-width:280px" />
      <button class="primary" id="createBtn">Create</button>
    </div>
  </div>

  <div class="card">
    <div class="row" style="justify-content: space-between;">
      <h2 style="margin:0">Albums</h2>
      <button class="ghost" id="refreshBtn">Refresh</button>
    </div>
    <div id="status" class="muted small"></div>
    <div style="overflow:auto;">
      <table>
        <thead>
          <tr>
            <th>albumId</th>
            <th>title</th>
            <th>secrets (one per line)</th>
            <th>rename</th>
            <th>actions</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    const tokenEl = $('token');
    const statusEl = $('status');
    const authInfoEl = $('authInfo');

    // Cloudflare Turnstile site key (injected by build step)
    const TURNSTILE_SITE_KEY = '__TURNSTILE_SITE_KEY__';

    function base64UrlDecodeToJson(b64url) {
      try {
        const b64 = b64url.replace(/-/g, '+').replace(/_/g, '/');
        const pad = b64.length % 4 === 0 ? '' : '='.repeat(4 - (b64.length % 4));
        const jsonStr = atob(b64 + pad);
        return JSON.parse(jsonStr);
      } catch {
        return null;
      }
    }

    async function getTurnstileTokenOnce() {
      if (!TURNSTILE_SITE_KEY || TURNSTILE_SITE_KEY === 'YOUR_TURNSTILE_SITE_KEY') return '';
      try {
        // Wait for Turnstile script to load (poll with timeout)
        await new Promise((resolve) => {
          const startedAt = Date.now();
          const tick = () => {
            if (typeof turnstile !== 'undefined') return resolve();
            if (Date.now() - startedAt > 3000) return resolve(); // 3s timeout
            setTimeout(tick, 50);
          };
          tick();
        });

        if (typeof turnstile === 'undefined') return '';

        return await new Promise((resolve) => {
          let resolved = false;
          const timeout = setTimeout(() => {
            if (!resolved) {
              resolved = true;
              resolve(''); // Timeout - continue without token
            }
          }, 5000);

          const widgetId = turnstile.render('#turnstile-widget', {
            sitekey: TURNSTILE_SITE_KEY,
            callback: (token) => {
              if (!resolved) {
                resolved = true;
                clearTimeout(timeout);
                resolve(token);
              }
            },
            'error-callback': () => {
              if (!resolved) {
                resolved = true;
                clearTimeout(timeout);
                resolve(''); // Continue without token on error
              }
            },
            size: 'normal',
            execution: 'execute'
          });

          try { turnstile.reset(widgetId); } catch {}
          try { turnstile.execute(widgetId); } catch { resolve(''); }
        });
      } catch (err) {
        console.warn('Turnstile verification failed:', err);
        return '';
      }
    }

    function getSessionToken() {
      return localStorage.getItem('ohmyphoto_admin_session') || '';
    }
    function setSessionToken(t) {
      localStorage.setItem('ohmyphoto_admin_session', t);
    }
    function clearSessionToken() {
      localStorage.removeItem('ohmyphoto_admin_session');
    }

    function getSessionPayload(sessionToken) {
      const t = String(sessionToken || '');
      const parts = t.split('.');
      if (parts.length !== 2) return null;
      return base64UrlDecodeToJson(parts[0]);
    }

    function enforceSessionFreshness() {
      const t = getSessionToken();
      if (!t) {
        authInfoEl.textContent = 'No session. Please login.';
        return;
      }
      const payload = getSessionPayload(t);
      if (!payload || typeof payload.iat !== 'number' || typeof payload.exp !== 'number') {
        clearSessionToken();
        authInfoEl.textContent = 'Invalid session. Please login again.';
        return;
      }
      const now = Date.now();
      if (payload.exp <= now) {
        clearSessionToken();
        authInfoEl.textContent = 'Session expired. Please login again.';
        return;
      }
      const ageMs = now - payload.iat;
      const twelveHoursMs = 5 * 24 * 60 * 60 * 1000;
      if (ageMs > twelveHoursMs) {
        clearSessionToken();
        authInfoEl.textContent = 'Session is old. Please login again.';
        return;
      }
      const hoursLeft = Math.max(0, Math.floor((payload.exp - now) / (60 * 60 * 1000)));
      authInfoEl.textContent = `Session OK. ~${hoursLeft}h left.`;
    }

    enforceSessionFreshness();

    $('logout').onclick = () => {
      clearSessionToken();
      authInfoEl.textContent = 'Logged out. Please login.';
      refresh().catch(() => {});
    };

    $('saveToken').onclick = async () => {
      const adminToken = tokenEl.value || '';
      if (!adminToken) {
        statusEl.textContent = 'Enter admin token.';
        return;
      }
      statusEl.textContent = 'Logging in...';
      const turnstileToken = await getTurnstileTokenOnce();
      const resp = await fetch('/api/admin/session', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ token: adminToken, turnstileToken })
      });
      if (!resp.ok) {
        statusEl.textContent = `Login failed: ${resp.status}`;
        return;
      }
      const data = await resp.json();
      if (!data.sessionToken) {
        statusEl.textContent = 'Login failed: no session token';
        return;
      }
      setSessionToken(data.sessionToken);
      tokenEl.value = '';
      enforceSessionFreshness();
      statusEl.textContent = 'Logged in.';
      await refresh();
    };

    async function api(path, options = {}) {
      enforceSessionFreshness();
      const token = getSessionToken();
      const headers = { ...(options.headers || {}) };
      if (token) headers['Authorization'] = `Bearer ${token}`;
      return fetch(path, { ...options, headers });
    }

    function parseSecrets(text) {
      return (text || '')
        .split('\n')
        .map(s => s.trim())
        .filter(Boolean);
    }

    async function refresh() {
      statusEl.textContent = 'Loading...';
      const resp = await api('/api/admin/albums', { method: 'GET' });
      if (resp.status === 401) {
        statusEl.textContent = 'Unauthorized (401). Set ADMIN_TOKEN.';
        $('tbody').innerHTML = '';
        return;
      }
      if (!resp.ok) {
        statusEl.textContent = `Error: ${resp.status}`;
        return;
      }
      const data = await resp.json();
      const albums = data.albums || [];

      const tbody = $('tbody');
      tbody.innerHTML = '';
      for (const a of albums) {
        const tr = document.createElement('tr');

        const tdId = document.createElement('td');
        tdId.textContent = a.albumId;
        tr.appendChild(tdId);

        const tdTitle = document.createElement('td');
        const titleInput = document.createElement('input');
        titleInput.value = a.title || 'OhMyPhoto';
        titleInput.style.minWidth = '220px';
        tdTitle.appendChild(titleInput);
        tr.appendChild(tdTitle);

        const tdSecrets = document.createElement('td');
        const secretsArea = document.createElement('textarea');
        secretsArea.placeholder = '';
        // Prevent password managers / autofill extensions from trying to hook into this field.
        // Some extensions inject buggy content scripts and can crash on focus.
        secretsArea.setAttribute('autocomplete', 'off');
        secretsArea.setAttribute('autocorrect', 'off');
        secretsArea.setAttribute('autocapitalize', 'none');
        secretsArea.setAttribute('spellcheck', 'false');
        secretsArea.setAttribute('inputmode', 'text');
        secretsArea.setAttribute('data-lpignore', 'true');   // LastPass
        secretsArea.setAttribute('data-1p-ignore', 'true');  // 1Password
        secretsArea.setAttribute('data-bwignore', 'true');   // Bitwarden
        secretsArea.setAttribute('data-form-type', 'other'); // generic hint for some autofill engines
        // Prefill existing secrets (one per line)
        secretsArea.value = (a.secrets || []).join('\n');
        tdSecrets.appendChild(secretsArea);
        const hint = document.createElement('div');
        hint.className = 'muted small';
        hint.textContent = `Current count: ${a.secretCount || 0}`;
        tdSecrets.appendChild(hint);
        tr.appendChild(tdSecrets);

        const tdRename = document.createElement('td');
        const renameInput = document.createElement('input');
        renameInput.placeholder = 'new-album-id';
        tdRename.appendChild(renameInput);
        tr.appendChild(tdRename);

        const tdActions = document.createElement('td');
        const saveBtn = document.createElement('button');
        saveBtn.className = 'primary';
        saveBtn.textContent = 'Save';
        saveBtn.onclick = async () => {
          const payload = { title: titleInput.value || 'OhMyPhoto' };
          // Always send secrets (allows clearing); textarea is prefilled from server.
          payload.secrets = parseSecrets(secretsArea.value);
          if (renameInput.value.trim()) payload.newAlbumId = renameInput.value.trim();
          const r = await api(`/api/admin/album/${encodeURIComponent(a.albumId)}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          if (!r.ok) {
            alert(`Save failed: ${r.status}`);
            return;
          }
          await refresh();
        };

        const delBtn = document.createElement('button');
        delBtn.className = 'danger';
        delBtn.textContent = 'Delete';
        delBtn.onclick = async () => {
          if (!confirm(`Delete album "${a.albumId}" and ALL its photos?`)) return;
          const r = await api(`/api/admin/album/${encodeURIComponent(a.albumId)}`, { method: 'DELETE' });
          if (!r.ok) {
            alert(`Delete failed: ${r.status}`);
            return;
          }
          await refresh();
        };

        tdActions.appendChild(saveBtn);
        tdActions.appendChild(document.createTextNode(' '));
        tdActions.appendChild(delBtn);
        tr.appendChild(tdActions);

        tbody.appendChild(tr);
      }
      statusEl.textContent = `Albums: ${albums.length}`;
    }

    $('refreshBtn').onclick = refresh;

    $('createBtn').onclick = async () => {
      const albumId = $('newAlbumId').value.trim();
      const title = $('newTitle').value.trim() || 'OhMyPhoto';
      if (!albumId) return alert('albumId required');
      const r = await api('/api/admin/album', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ albumId, title })
      });
      if (!r.ok) {
        const t = await r.text();
        alert(`Create failed: ${r.status} ${t}`);
        return;
      }
      $('newAlbumId').value = '';
      await refresh();
    };

    refresh().catch(err => {
      statusEl.textContent = String(err);
    });
  </script>
</body>
</html>


