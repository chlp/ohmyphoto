<!-- GENERATED FILE: edit `src/client/index.template.html` and run `node scripts/build-assets.mjs` -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <title>OhMyPhoto</title>
  <meta name="robots" content="noindex,nofollow" />
  <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
</head>
<body>
  <h1 id="title">OhMyPhoto</h1>
  <div id="status"></div>
  <div id="grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px;"></div>
  <!-- Turnstile widget container (kept off-screen to avoid layout impact) -->
  <div id="turnstile-widget" style="position:absolute;left:-9999px;top:0;width:1px;height:1px;overflow:hidden;"></div>

  <script>
    function getAlbumIdFromPath() {
      // expect /<albumId>
      const parts = location.pathname.split('/').filter(Boolean);
      return parts[0] || '';
    }

    // Cloudflare Turnstile site key (injected by build step)
    const TURNSTILE_SITE_KEY = '__TURNSTILE_SITE_KEY__';

    async function main() {
      const albumId = getAlbumIdFromPath();
      const secret = (location.hash || '').replace(/^#/, '');

      const statusEl = document.getElementById('status');
      const gridEl = document.getElementById('grid');
      const titleEl = document.getElementById('title');

      if (!albumId) {
        statusEl.textContent = 'No albumId in URL. Expected /<albumId>#<secret>';
        return;
      }
      if (!secret) {
        statusEl.textContent = 'No secret in URL hash. Expected /<albumId>#<secret>';
        return;
      }

      statusEl.textContent = 'Loading...';

      // Get Turnstile token if site key is configured
      let turnstileToken = '';
      if (TURNSTILE_SITE_KEY && TURNSTILE_SITE_KEY !== 'YOUR_TURNSTILE_SITE_KEY') {
        try {
          // Wait for Turnstile script to load (poll with timeout)
          await new Promise((resolve) => {
            const startedAt = Date.now();
            const tick = () => {
              if (typeof turnstile !== 'undefined') return resolve();
              if (Date.now() - startedAt > 3000) return resolve(); // 3s timeout
              setTimeout(tick, 50);
            };
            tick();
          });

          if (typeof turnstile !== 'undefined') {
            turnstileToken = await new Promise((resolve) => {
              let resolved = false;
              const timeout = setTimeout(() => {
                if (!resolved) {
                  resolved = true;
                  resolve(''); // Timeout - continue without token
                }
              }, 5000);

              const widgetId = turnstile.render('#turnstile-widget', {
                sitekey: TURNSTILE_SITE_KEY,
                callback: (token) => {
                  if (!resolved) {
                    resolved = true;
                    clearTimeout(timeout);
                    resolve(token);
                  }
                },
                'error-callback': () => {
                  if (!resolved) {
                    resolved = true;
                    clearTimeout(timeout);
                    resolve(''); // Continue without token on error
                  }
                },
                // Current Turnstile JS API accepts: "compact" | "flexible" | "normal"
                size: 'normal',
                // Avoid auto-execution; we will execute explicitly once.
                execution: 'execute'
              });

              // Execute the challenge once (reset first to avoid "already executing" warnings)
              try { turnstile.reset(widgetId); } catch {}
              try { turnstile.execute(widgetId); } catch { resolve(''); }
            });
          }
        } catch (err) {
          console.warn('Turnstile verification failed:', err);
          // Continue without token if Turnstile fails
        }
      }

      const resp = await fetch(`/api/album/${encodeURIComponent(albumId)}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ secret, turnstileToken })
      });

      if (resp.status === 404) {
        statusEl.textContent = 'Album not found (404)';
        return;
      }
      if (resp.status === 403) {
        statusEl.textContent = 'Forbidden (403): wrong secret';
        return;
      }
      if (!resp.ok) {
        statusEl.textContent = `Error: ${resp.status}`;
        return;
      }

      const data = await resp.json();
      const baseTitle = 'OhMyPhoto';
      const albumTitle = data.title || baseTitle;

      titleEl.textContent = albumTitle;
      document.title = albumTitle === baseTitle ? baseTitle : `${albumTitle} | ${baseTitle}`;

      if (data.files.length === 0) {
        statusEl.textContent = 'This is the correct link, but the photos havenâ€™t been uploaded here yet.';
      } else {
        statusEl.textContent = '';
      }

      // Render previews if worker returns previewUrl
      gridEl.innerHTML = '';
      for (const f of data.files) {
        const wrap = document.createElement('div');
        wrap.style.border = '1px solid #ddd';
        wrap.style.padding = '8px';

        const img = document.createElement('img');
        img.loading = 'lazy';
        img.style.width = '100%';
        img.style.height = '160px';
        img.style.objectFit = 'cover';
        img.src = f.previewUrl || '';

        const a = document.createElement('a');
        a.textContent = f.name;
        a.href = f.photoUrl || '#';
        a.target = '_blank';
        a.rel = 'noreferrer';

        wrap.appendChild(img);
        wrap.appendChild(document.createElement('div')).appendChild(a);
        gridEl.appendChild(wrap);
      }
    }

    main().catch(err => {
      document.getElementById('status').textContent = String(err);
    });
  </script>
</body>
</html>

