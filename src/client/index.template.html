<!-- GENERATED FILE: edit `src/client/index.template.html` and run `node scripts/build-assets.mjs` -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <title>OhMyPhoto</title>
  <meta name="robots" content="noindex,nofollow" />
  <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
</head>
<body>
  <h1 id="title">OhMyPhoto</h1>
  <div id="status"></div>
  <div id="grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px;"></div>
  <!-- Turnstile widget container (kept off-screen to avoid layout impact) -->
  <div id="turnstile-widget" style="position:absolute;left:-9999px;top:0;width:1px;height:1px;overflow:hidden;"></div>

  <script>
    function getAlbumIdFromPath() {
      // expect /<albumId>
      const parts = location.pathname.split('/').filter(Boolean);
      return parts[0] || '';
    }

    // Cloudflare Turnstile site key (injected by build step)
    const TURNSTILE_SITE_KEY = '__TURNSTILE_SITE_KEY__';

    async function main() {
      const albumId = getAlbumIdFromPath();
      const secret = (location.hash || '').replace(/^#/, '');
      const debug = new URL(location.href).searchParams.get('debug') === '1';

      const statusEl = document.getElementById('status');
      const gridEl = document.getElementById('grid');
      const titleEl = document.getElementById('title');

      const startedAt = performance.now();
      const log = (...args) => { if (debug) console.log('[ohmyphoto]', ...args); };
      const setStatus = (s) => { statusEl.textContent = s; log('status:', s); };
      const ms = () => Math.round(performance.now() - startedAt);

      if (!albumId) {
        setStatus('No albumId in URL. Expected /<albumId>#<secret>');
        return;
      }
      if (!secret) {
        setStatus('No secret in URL hash. Expected /<albumId>#<secret>');
        return;
      }

      setStatus('Loading...');

      // Get Turnstile token if site key is configured
      let turnstileToken = '';
      if (TURNSTILE_SITE_KEY && TURNSTILE_SITE_KEY !== 'YOUR_TURNSTILE_SITE_KEY') {
        try {
          setStatus('Verifying...');
          const t0 = performance.now();
          // Wait for Turnstile script to load (poll with timeout)
          await new Promise((resolve) => {
            const startedAt = Date.now();
            const tick = () => {
              if (typeof turnstile !== 'undefined') return resolve();
              if (Date.now() - startedAt > 3000) return resolve(); // 3s timeout
              setTimeout(tick, 50);
            };
            tick();
          });

          if (typeof turnstile !== 'undefined') {
            turnstileToken = await new Promise((resolve) => {
              let resolved = false;
              const timeout = setTimeout(() => {
                if (!resolved) {
                  resolved = true;
                  resolve(''); // Timeout - continue without token
                }
              }, 5000);

              const widgetId = turnstile.render('#turnstile-widget', {
                sitekey: TURNSTILE_SITE_KEY,
                callback: (token) => {
                  if (!resolved) {
                    resolved = true;
                    clearTimeout(timeout);
                    resolve(token);
                  }
                },
                'error-callback': () => {
                  if (!resolved) {
                    resolved = true;
                    clearTimeout(timeout);
                    resolve(''); // Continue without token on error
                  }
                },
                size: 'invisible',
              });
            });
          }
          log('turnstile token len=', String(turnstileToken || '').length, 'ms=', Math.round(performance.now() - t0));
        } catch (err) {
          console.warn('Turnstile verification failed:', err);
          // Continue without token if Turnstile fails
        }
      }

      setStatus('Fetching album...');
      const controller = new AbortController();
      const timeoutMs = 15000;
      const timeout = setTimeout(() => controller.abort(new Error('Request timeout')), timeoutMs);
      let resp;
      try {
        const tApi = performance.now();
        resp = await fetch(`/api/album/${encodeURIComponent(albumId)}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            ...(debug ? { 'X-OhMyPhoto-Debug': '1' } : {})
          },
          body: JSON.stringify({ secret, turnstileToken }),
          signal: controller.signal
        });
        log('album api status=', resp.status, 'ms=', Math.round(performance.now() - tApi));
        if (debug) {
          const rid = resp.headers.get('X-Request-Id');
          const st = resp.headers.get('Server-Timing');
          if (rid) log('request-id=', rid);
          if (st) log('server-timing=', st);
        }
      } finally {
        clearTimeout(timeout);
      }

      if (resp.status === 404) {
        setStatus('Album not found (404)');
        return;
      }
      if (resp.status === 403) {
        setStatus('Forbidden (403): wrong secret / bot check failed');
        return;
      }
      if (!resp.ok) {
        setStatus(`Error: ${resp.status}`);
        return;
      }

      const data = await resp.json();
      const baseTitle = 'OhMyPhoto';
      const albumTitle = data.title || baseTitle;

      titleEl.textContent = albumTitle;
      document.title = albumTitle === baseTitle ? baseTitle : `${albumTitle} | ${baseTitle}`;

      if (data.files.length === 0) {
        setStatus('This is the correct link, but the photos havenâ€™t been uploaded here yet.');
      } else {
        setStatus('');
      }

      // Render previews if worker returns previewUrl
      gridEl.innerHTML = '';
      for (const f of data.files) {
        const wrap = document.createElement('div');
        wrap.style.border = '1px solid #ddd';
        wrap.style.padding = '8px';

        const img = document.createElement('img');
        img.loading = 'lazy';
        img.style.width = '100%';
        img.style.height = '160px';
        img.style.objectFit = 'cover';
        img.src = f.previewUrl || '';

        const a = document.createElement('a');
        a.textContent = f.name;
        a.href = f.photoUrl || '#';
        a.target = '_blank';
        a.rel = 'noreferrer';

        wrap.appendChild(img);
        wrap.appendChild(document.createElement('div')).appendChild(a);
        gridEl.appendChild(wrap);
      }
    }

    main().catch(err => {
      const msg = (err && err.name === 'AbortError')
        ? 'Request timed out. Try again (or add ?debug=1 and check console).'
        : String(err && (err.stack || err.message || err));
      document.getElementById('status').textContent = msg;
    });
  </script>
</body>
</html>

